#
# This will use himlarcli to prepare a compute host for reinstall
# {{ hosts }} should be a host with himlarcli installed
# {{ compute_host }} should be the compute host
# 
# Last verified: 2018-03-23 (ansible version 2.4.2.0)
#
- hosts: "{{ hosts }}"
  tasks:
    - name: "Check for instances on {{ hosts }}"
      virt: command=list_vms
      register: instances
    #- debug: var=instances.list_vms
    - fail:
        msg: "{{hosts}} has running instances!!!"
      when: instances.list_vms | length > 0
    - name: Set foreman to rebuild
      command: bin/python rebuild.py {{compute_host}} chdir={{himlarcli_path}}
      when: location != 'vagrant'
