- hosts: "{{ myhosts }}"
  vars:
    repo_dir: '/opt/repo/secrets/nodes/'
    location: "{{ ansible_hostname | regex_replace('(^.+?)-.+?-.+$', '\\1') }}"
  tasks:
    - name: copy secret files to host
      copy: src={{repo_dir}}/{{ location }}-identity/token-secret-key.gpg dest=/tmp/token-secret-key.gpg owner=root group=root mode=600
    - name: Create symlink
      file:
        src: {{repo_dir}}/{{ location }}-identity/token-secret-key.gpg dest=/tmp/token-secret-key.gpg 
        dest: {{repo_dir}}/{{ansible_hostname}}/token-secret-key.gpg
        state: link

    - name: check if there already is a token key
      shell: gpg --list-secret-keys --fingerprint --with-colon 'UH-IaaS Token Distributor' | awk -F':' '/^fpr:/ { print $10 }'
      register: token_key_id
    - name: delete existing gpg-key if it exists
      shell: gpg --batch --yes --delete-secret-keys {{token_key_id.stdout}}
      when: token_key_id.stdout | length > 0
    - name: import gpg-key
      shell: gpg --import /tmp/token-secret-key.gpg
    - name: delete after importing
      file: name=/tmp/token-secret-key.gpg state=absent
