- hosts: "{{ hosts }}"
  vars:
    repo_dir: '/opt/repo/secrets/nodes/'
  tasks:
    - name: copy secret files to host
      copy: src={{repo_dir}}/{{ansible_hostname}}/token-secret-key.gpg dest=/tmp/token-secret-key.gpg owner={{item.value.owner}} group={{item.value.group}} mode={{item.value.mode}}
      with_dict: "{{ secret_files }}"
    - name: check if there already is a token key
      shell: gpg --list-secret-keys --with-colons 'UH-IaaS Token Distributor' 2> /dev/null | awk -F: '/^sec:/ { print $5 }'
      register: token_key_id
    - name: delete existing gpg-key if it exists
      shell: gpg --delete-secret-keys {{token_key_id}}
      when: token_key_id || length > 0
    - name: import gpg-key
      shell: gpg --import /tmp/token-secret-key.gpg
    - name: delete after importing
      file: name=/tmp/token-secret-key.gpg state=absent
